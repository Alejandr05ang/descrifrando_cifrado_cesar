<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La M√°quina Enigm√°tica</title>
    <style>
        /* =========================================
           VARIABLES Y ESTILOS GLOBALES
           ========================================= */
        :root {
            --bg-color: #0f172a;
            --panel-bg: #1e293b;
            --text-color: #f8fafc;
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --accent: #10b981;
            --machine-bg: #0b0f19;
            --portal-color: #6366f1;
            --font-main: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 1rem;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            color: var(--primary);
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
            cursor: pointer; /* Pista para el click oculto */
            user-select: none;
        }

        p.subtitle {
            color: #94a3b8;
            margin-bottom: 2rem;
            text-align: center;
        }

        .container {
            width: 100%;
            max-width: 900px;
            display: grid;
            gap: 2rem;
            grid-template-columns: 1fr;
        }

        /* =========================================
           √ÅREA DE LA M√ÅQUINA Y ANIMACI√ìN
           ========================================= */
        .machine-section {
            background-color: var(--panel-bg);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Escenario de la animaci√≥n */
        .stage {
            position: relative;
            width: 100%;
            max-width: 600px;
            height: 140px;
            margin: 2rem 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            overflow: hidden;
            border-bottom: 4px solid #334155;
        }

        /* Portales (Entrada y Salida) */
        .portal {
            width: 40px;
            height: 100px;
            background: linear-gradient(to right, var(--portal-color), #312e81);
            border-radius: 8px;
            position: relative;
            z-index: 10;
            box-shadow: 0 0 15px var(--portal-color);
        }

        .portal.left { border-radius: 8px 0 0 8px; }
        .portal.right { border-radius: 0 8px 8px 0; background: linear-gradient(to left, var(--portal-color), #312e81); }

        /* La Caja Negra central */
        .black-box {
            width: 160px;
            height: 120px;
            background-color: var(--machine-bg);
            border: 3px solid #334155;
            border-radius: 12px;
            z-index: 5;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            font-weight: bold;
            font-family: monospace;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        /* Efecto de procesamiento */
        .black-box.processing {
            border-color: var(--accent);
            color: var(--accent);
            box-shadow: 0 0 25px rgba(16, 185, 129, 0.4) inset, 0 0 20px rgba(16, 185, 129, 0.6);
        }
        
        .black-box.processing::after {
            content: '';
            position: absolute;
            top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(16, 185, 129, 0.2), transparent);
            animation: scan 0.6s linear infinite;
        }

        @keyframes scan {
            0% { left: -50%; }
            100% { left: 150%; }
        }

        /* Texto animado */
        .moving-text {
            position: absolute;
            font-size: 1.5rem;
            font-weight: bold;
            color: #fff;
            background: #475569;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            white-space: nowrap;
            z-index: 2; /* Por debajo de los portales y la caja */
        }

        .text-in {
            animation: slideIn 1s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        .text-out {
            animation: slideOut 1s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes slideIn {
            0% { left: 20px; opacity: 0; transform: scale(0.8); }
            20% { opacity: 1; transform: scale(1); }
            100% { left: 50%; transform: translateX(-50%) scale(0.5); opacity: 0; }
        }

        @keyframes slideOut {
            0% { right: 50%; transform: translateX(50%) scale(0.5); opacity: 0; }
            80% { opacity: 1; transform: scale(1); }
            100% { right: 20px; opacity: 0; transform: scale(0.8); }
        }

        /* =========================================
           CONTROLES E INPUT
           ========================================= */
        .controls {
            display: flex;
            gap: 1rem;
            width: 100%;
            max-width: 500px;
        }

        input[type="text"] {
            flex: 1;
            padding: 0.8rem 1.2rem;
            font-size: 1.1rem;
            border: 2px solid #334155;
            border-radius: 8px;
            background-color: #0f172a;
            color: white;
            outline: none;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus {
            border-color: var(--primary);
        }

        button {
            padding: 0.8rem 1.5rem;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
        }

        .btn-submit {
            background-color: var(--primary);
        }
        .btn-submit:hover:not(:disabled) {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
        }
        .btn-submit:disabled {
            background-color: #475569;
            cursor: not-allowed;
        }

        /* =========================================
           PANELES INFERIORES (Historial y Pistas)
           ========================================= */
        .bottom-panels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 768px) {
            .bottom-panels { grid-template-columns: 1fr; }
        }

        .panel {
            background-color: var(--panel-bg);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .panel h2 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #94a3b8;
        }

        /* Pistas */
        .btn-hint {
            background-color: #f59e0b;
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }
        .btn-hint:hover { background-color: #d97706; }

        .hints-container {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .hint-card {
            background-color: #334155;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #f59e0b;
            animation: fadeIn 0.5s ease;
        }

        /* Historial */
        .btn-clear {
            background-color: #ef4444;
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }
        .btn-clear:hover { background-color: #dc2626; }

        .history-list {
            list-style: none;
            max-height: 250px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .history-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #0f172a;
            padding: 0.8rem 1rem;
            border-radius: 8px;
            animation: fadeIn 0.3s ease;
        }

        .history-arrow {
            color: var(--accent);
            font-weight: bold;
            margin: 0 1rem;
        }

        .original-text { color: #cbd5e1; }
        .result-text { color: var(--accent); font-weight: bold; font-family: monospace; font-size: 1.1rem; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Scrollbar personalizado */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--panel-bg); }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

    </style>
</head>
<body>

    <h1 id="app-title">La M√°quina Enigm√°tica</h1>
    <p class="subtitle">Introduce una palabra o letra y descubre su secreto...</p>

    <div class="container">
        <!-- SECCI√ìN DE LA M√ÅQUINA PRINCIPAL -->
        <div class="machine-section">
            <div class="stage" id="stage">
                <div class="portal left"></div>
                
                <div class="black-box" id="blackBox">
                    <span id="machineStatus">En espera</span>
                </div>
                
                <div class="portal right"></div>
            </div>

            <form class="controls" id="cipherForm">
                <input type="text" id="textInput" placeholder="Escribe aqu√≠..." autocomplete="off" maxlength="25" required>
                <button type="submit" class="btn-submit" id="submitBtn">Enviar</button>
            </form>
        </div>

        <!-- PANELES INFERIORES -->
        <div class="bottom-panels">
            <!-- Panel de Pistas -->
            <div class="panel">
                <h2>
                    Descubrimiento
                    <button type="button" class="btn-hint" id="hintBtn">Mostrar pista üí°</button>
                </h2>
                <div class="hints-container" id="hintsContainer">
                    <!-- Las pistas aparecer√°n aqu√≠ din√°micamente -->
                </div>
            </div>

            <!-- Panel de Historial -->
            <div class="panel">
                <h2>
                    Registro
                    <button type="button" class="btn-clear" id="clearBtn">Limpiar üóëÔ∏è</button>
                </h2>
                <ul class="history-list" id="historyList">
                    <!-- Los resultados aparecer√°n aqu√≠ -->
                </ul>
            </div>
        </div>
    </div>

    <script>
        /* =========================================
           CONFIGURACI√ìN Y ESTADO GLOBAL
           ========================================= */
        // Cargar el shift oculto desde localStorage o usar 3 por defecto
        let currentShift = parseInt(localStorage.getItem('caesarShift')) || 3;
        
        let isProcessing = false;
        
        // Pistas pedag√≥gicas progresivas
        const hints = [
            "1. Observa detenidamente c√≥mo cambian las letras antes y despu√©s de pasar por la m√°quina.",
            "2. Intenta ingresar la letra 'A'. ¬øQu√© letra sale? Luego intenta con la 'B'.",
            "3. ¬øNotaste que todas las letras parecen cambiar por la misma cantidad?",
            "4. Piensa en el alfabeto como un ciclo: si llegas a la 'Z', la siguiente letra vuelve a ser la 'A'.",
            "5. Cada letra se mueve un n√∫mero fijo de posiciones en el abecedario.",
            "6. ¬°Felicidades! Este m√©todo hist√≥rico se conoce como el 'Cifrado C√©sar'."
        ];
        let currentHintIndex = parseInt(localStorage.getItem('currentHintIndex')) || 0;

        /* =========================================
           REFERENCIAS AL DOM
           ========================================= */
        const form = document.getElementById('cipherForm');
        const input = document.getElementById('textInput');
        const submitBtn = document.getElementById('submitBtn');
        const stage = document.getElementById('stage');
        const blackBox = document.getElementById('blackBox');
        const machineStatus = document.getElementById('machineStatus');
        const historyList = document.getElementById('historyList');
        const hintsContainer = document.getElementById('hintsContainer');
        const hintBtn = document.getElementById('hintBtn');
        const clearBtn = document.getElementById('clearBtn');
        const appTitle = document.getElementById('app-title');

        /* =========================================
           INICIALIZACI√ìN
           ========================================= */
        // Cargar historial previo (opcional, aqu√≠ iniciamos vac√≠o pero restauramos pistas)
        function init() {
            // Restaurar pistas visibles si se recarga la p√°gina
            for (let i = 0; i < currentHintIndex; i++) {
                renderHint(hints[i]);
            }
            updateHintButton();
        }

        /* =========================================
           L√ìGICA DEL CIFRADO C√âSAR
           ========================================= */
        function applyCaesarCipher(str, shift) {
            // Normalizar el shift para asegurar que sea positivo y entre 0-25
            const normalizedShift = ((shift % 26) + 26) % 26;
            
            return str.replace(/[a-zA-Z]/g, function(char) {
                // Determinar si es may√∫scula o min√∫scula para la base ASCII
                const base = char <= 'Z' ? 65 : 97; 
                // Aplicar rotaci√≥n y envolver
                return String.fromCharCode(((char.charCodeAt(0) - base + normalizedShift) % 26) + base);
            });
        }

        /* =========================================
           ORQUESTADOR DE ANIMACI√ìN
           ========================================= */
        async function processEncryption(text) {
            if (isProcessing || text.trim() === '') return;
            
            isProcessing = true;
            submitBtn.disabled = true;
            input.value = ''; // Limpiar input para la siguiente entrada

            const encryptedText = applyCaesarCipher(text, currentShift);

            // 1. Crear elemento de entrada (Animaci√≥n de portal izquierdo a centro)
            const elIn = document.createElement('div');
            elIn.className = 'moving-text text-in';
            elIn.innerText = text;
            stage.appendChild(elIn);

            // Sonido simulado suave opcional (usando AudioContext si se desea, aqu√≠ lo omitimos para mantenerlo puro sin assets externos, pero la pausa da la sensaci√≥n)
            
            // Esperar que la animaci√≥n de entrada termine (1 segundo seg√∫n el CSS)
            await sleep(1000);
            elIn.remove();

            // 2. Efecto de la M√°quina (Caja Negra procesando)
            blackBox.classList.add('processing');
            machineStatus.innerText = "Procesando...";
            
            // Delay pedag√≥gico para crear expectativa (800ms)
            await sleep(800);
            
            blackBox.classList.remove('processing');
            machineStatus.innerText = "¬°Completado!";

            // 3. Crear elemento de salida (Animaci√≥n de centro a portal derecho)
            const elOut = document.createElement('div');
            elOut.className = 'moving-text text-out';
            elOut.innerText = encryptedText;
            stage.appendChild(elOut);

            // Esperar que termine de salir
            await sleep(1000);
            elOut.remove();
            
            // Restaurar estado de m√°quina
            machineStatus.innerText = "En espera";

            // 4. Agregar al registro visual
            addToHistory(text, encryptedText);

            isProcessing = false;
            submitBtn.disabled = false;
            input.focus();
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        /* =========================================
           MANEJO DE HISTORIAL Y UI
           ========================================= */
        function addToHistory(original, result) {
            const li = document.createElement('li');
            li.className = 'history-item';
            li.innerHTML = `
                <span class="original-text">${escapeHTML(original)}</span>
                <span class="history-arrow">‚ûî</span>
                <span class="result-text">${escapeHTML(result)}</span>
            `;
            // Insertar al principio para ver el m√°s reciente arriba
            historyList.insertBefore(li, historyList.firstChild);
        }

        clearBtn.addEventListener('click', () => {
            historyList.innerHTML = '';
            input.focus();
        });

        // Prevenir inyecci√≥n de HTML b√°sico
        function escapeHTML(str) {
            return str.replace(/[&<>'"]/g, 
                tag => ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    "'": '&#39;',
                    '"': '&quot;'
                }[tag] || tag)
            );
        }

        /* =========================================
           SISTEMA DE PISTAS (DESCUBRIMIENTO)
           ========================================= */
        function renderHint(text) {
            const div = document.createElement('div');
            div.className = 'hint-card';
            div.innerText = text;
            hintsContainer.appendChild(div);
        }

        function updateHintButton() {
            if (currentHintIndex >= hints.length) {
                hintBtn.style.display = 'none';
                localStorage.setItem('currentHintIndex', currentHintIndex);
            }
        }

        hintBtn.addEventListener('click', () => {
            if (currentHintIndex < hints.length) {
                renderHint(hints[currentHintIndex]);
                currentHintIndex++;
                localStorage.setItem('currentHintIndex', currentHintIndex);
                updateHintButton();
                
                // Auto-scroll al fondo del contenedor de pistas
                hintsContainer.scrollTop = hintsContainer.scrollHeight;
            }
        });

        /* =========================================
           EVENTOS PRINCIPALES
           ========================================= */
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const text = input.value;
            processEncryption(text);
        });

        /* =========================================
           CONFIGURACI√ìN OCULTA (PROFESORES)
           ========================================= */
        
        // Funci√≥n para cambiar el desplazamiento
        function triggerHiddenConfig() {
            const userInput = prompt(`‚öôÔ∏è MODO PROFESOR ‚öôÔ∏è\nConfiguraci√≥n actual del desplazamiento: ${currentShift}\n\nIngresa un nuevo n√∫mero para cambiar el patr√≥n (ej: 5 para desplazar 5 letras):`);
            
            if (userInput !== null && userInput.trim() !== '') {
                const parsed = parseInt(userInput);
                if (!isNaN(parsed)) {
                    currentShift = parsed;
                    localStorage.setItem('caesarShift', currentShift);
                    
                    // Reiniciar pistas e historial al cambiar el patr√≥n para no confundir
                    currentHintIndex = 0;
                    localStorage.setItem('currentHintIndex', 0);
                    hintsContainer.innerHTML = '';
                    historyList.innerHTML = '';
                    hintBtn.style.display = 'block';
                    
                    alert(`‚úÖ Desplazamiento actualizado exitosamente a: ${currentShift}\nEl historial y las pistas han sido reiniciados.`);
                } else {
                    alert("‚ùå Error: Debes ingresar un n√∫mero v√°lido.");
                }
            }
        }

        // M√©todo oculto 1: Combinaci√≥n de teclas (Ctrl + Shift + S)
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && (e.key === 's' || e.key === 'S')) {
                e.preventDefault();
                triggerHiddenConfig();
            }
        });

        // M√©todo oculto 2: 5 Clics r√°pidos en el t√≠tulo principal
        let clickCount = 0;
        let clickTimer;
        
        appTitle.addEventListener('click', () => {
            clickCount++;
            clearTimeout(clickTimer);
            
            // Si no se hace el siguiente clic en 800ms, se reinicia el contador
            clickTimer = setTimeout(() => {
                clickCount = 0;
            }, 800);
            
            if (clickCount >= 5) {
                triggerHiddenConfig();
                clickCount = 0; // Resetear despu√©s de activar
            }
        });

        // Arrancar la app
        init();
    </script>
</body>
</html>